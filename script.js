new ClipboardJS(".bucket");let output=document.getElementById("output"),canvasHolder=document.getElementById("canvasHolder"),imagePreview=document.getElementById("imagePreview"),results=document.getElementById("results"),drop=document.getElementById("drop"),dropText=document.getElementById("dropText"),dropInput=document.getElementById("dropInput"),paletteOutput=document.getElementById("paletteOutput"),downscaleOutput=document.getElementById("downscaleOutput"),colorSpaceOutput=document.getElementById("colorSpaceOutput"),upscaledImage=document.getElementById("upscaledImage");function reset(){for(colorFreq=[[],[],[]],maxFreq=-1;imagePreview.childNodes[1]&&imagePreview.removeChild(imagePreview.childNodes[1]););for(;output.childNodes[1]&&output.removeChild(output.childNodes[1]););for(;canvasHolder.childNodes[1]&&canvasHolder.removeChild(canvasHolder.childNodes[1]););for(;paletteOutput.childNodes[1]&&paletteOutput.removeChild(paletteOutput.childNodes[1]););for(;downscaleOutput.childNodes[1]&&downscaleOutput.removeChild(downscaleOutput.childNodes[1]););for(;colorSpaceOutput.childNodes[1]&&colorSpaceOutput.removeChild(colorSpaceOutput.childNodes[1]););for(;upscaledImage.childNodes[1]&&upscaledImage.removeChild(upscaledImage.childNodes[1]););}function rgbToHsl(e,t,a){e/=255,t/=255,a/=255;var l,o,r=Math.max(e,t,a),n=Math.min(e,t,a),d=(r+n)/2;if(r==n)l=o=0;else{var c=r-n;switch(o=d>.5?c/(2-r-n):c/(r+n),r){case e:l=(t-a)/c+(t<a?6:0);break;case t:l=(a-e)/c+2;break;case a:l=(e-t)/c+4}l/=6}return[l,o,d]}function hslToRgb(e,t,a){var l,o,r;if(0==t)l=o=r=a;else{function n(e,t,a){return a<0&&(a+=1),a>1&&(a-=1),a<1/6?e+6*(t-e)*a:a<.5?t:a<2/3?e+(t-e)*(2/3-a)*6:e}var d=a<.5?a*(1+t):a+t-a*t,c=2*a-d;l=n(c,d,e+1/3),o=n(c,d,e),r=n(c,d,e-1/3)}return[255*l,255*o,255*r]}function rgbToHex(e,t,a){return"#"+((1<<24)+(e<<16)+(t<<8)+a).toString(16).slice(1)}function sortImage(e){let t=document.createElement("canvas"),a=t.width=e.naturalWidth,l=t.height=e.naturalHeight,o=t.getContext("2d");o.drawImage(e,0,0);let r=o.getImageData(0,0,a,l),n=r.data,d=[];for(let e=0;e<n.length;e+=4){let t=rgbToHsl(n[e],n[e+1],n[e+2]);d.push([t[0],t[1],t[2],n[e+3]])}d.sort((e,t)=>e[0]-t[0]);for(let e=0;e<n.length;e+=4){let t=hslToRgb(d[e/4][0],d[e/4][1],d[e/4][2]);n[e]=t[0],n[e+1]=t[1],n[e+2]=t[2],n[e+3]=d[e/4][3]}o.putImageData(r,0,0);let c=document.createElement("img");c.src=t.toDataURL("image/png"),output.appendChild(c)}let histogram=e=>{e.setup=(()=>{WIDTH=canvasHolder.getBoundingClientRect().width,HEIGHT=300,e.createCanvas(WIDTH,HEIGHT).parent("canvasHolder"),colors=["rgba(255, 0, 0, 0.4)","rgba(0, 255, 0, 0.4)","rgba(0, 0, 255, 0.4)"],e.noStroke(),e.background("rgba(192, 222, 217, 0.25)");for(let t=0;t<3;t++){e.fill(colors[t]);for(let a=0;a<256;a++){let l=0==colorFreq[t][a]?0:colorFreq[t][a]/maxFreq*WIDTH/2;e.rect(a*(WIDTH/256),HEIGHT-l,WIDTH/256,l)}}})};function makeHistogram(e){let t=document.createElement("canvas"),a=t.width=e.naturalWidth,l=t.height=e.naturalHeight,o=t.getContext("2d");o.drawImage(e,0,0);let r=o.getImageData(0,0,a,l).data;for(let e=0;e<3;e++)for(let t=0;t<256;t++)colorFreq[e].push(0);for(let e=0;e<r.length;e+=4)for(let t=0;t<3;t++)colorFreq[t][r[e+t]]+=1;for(let e=0;e<3;e++)for(let t=0;t<256;t++)colorFreq[e][t]>maxFreq&&(maxFreq=colorFreq[e][t]);new p5(histogram)}function recursiveSplit(e,t){if(0==e.length)return;if(0==t)return void colorBuckets.push(e);let a=[255,255,255],l=[0,0,0],o=[];for(let t=0;t<e.length;t+=4)for(let o=0;o<3;o++)a[o]=Math.min(a[o],e[t][o]),l[o]=Math.max(l[o],e[t][o]);o[0]=Math.abs(l[0]-a[0]),o[1]=Math.abs(l[1]-a[1]),o[2]=Math.abs(l[2]-a[2]);let r=Math.max(o[0],Math.max(o[1],o[2]));o[0]==r?e.sort((e,t)=>e[0]-t[0]):o[1]==r?e.sort((e,t)=>e[1]-t[1]):o[2]==r&&e.sort((e,t)=>e[2]-t[2]);let n=Math.floor(e.length/2);recursiveSplit(e.slice(0,n),t-1),recursiveSplit(e.slice(n,e.length),t-1)}function makePalette(e,t){let a=document.createElement("canvas"),l=a.width=e.naturalWidth,o=a.height=e.naturalHeight,r=a.getContext("2d");r.drawImage(e,0,0);let n=r.getImageData(0,0,l,o).data,d=[];for(let e=0;e<n.length;e+=4){let t=new Array(3);t[0]=n[e],t[1]=n[e+1],t[2]=n[e+2],d.push(t)}recursiveSplit(d,t)}function getAverages(){let e=[];for(let t=0;t<colorBuckets.length;t++){let a=[0,0,0];for(let e=0;e<colorBuckets[t].length;e++)for(let l=0;l<3;l++)a[l]+=colorBuckets[t][e][l];let l=[Math.floor(a[0]/colorBuckets[t].length),Math.floor(a[1]/colorBuckets[t].length),Math.floor(a[2]/colorBuckets[t].length)];e.push(l)}return e}function getColorName(e){return fetch("https://www.thecolorapi.com/id?hex="+e).then(e=>e.json()).then(e=>e)}function getFillColor(e,t,a,l){let o=[0,0,0];return o[e]=a,o[t]=l,o}function downscaleImage(e){let t=document.createElement("canvas"),a=t.getContext("2d");t.height=t.width*(e.naturalHeight/e.naturalWidth);let l=document.createElement("canvas"),o=l.getContext("2d");l.width=.5*e.naturalWidth,l.height=.5*e.naturalHeight,o.drawImage(e,0,0,l.width,l.height),o.drawImage(l,0,0,.5*l.width,.5*l.height),a.drawImage(l,0,0,.5*l.width,.5*l.height,0,0,t.width,t.height);let r=a.getImageData(0,0,t.width,t.height).data,n=document.createElement("img");return n.src=t.toDataURL("image/png"),downscaleOutput.appendChild(n),r}var tempArr=[];function generateColorSpace(e,t,a){let l=document.createElement("canvas"),o=(l.width=256,l.height=256),r=l.getContext("2d");for(let l=0;l<a.length;l+=4)if(a[l+e]&&a[l+t]){r.beginPath();let n=[0,0,0];n[e]=a[l+e],n[t]=a[l+t],r.rect(n[e],o-n[t],1,1),r.fillStyle=rgbToHex(n[0],n[1],n[2]),r.fill()}let n=document.createElement("img");n.src=l.toDataURL("image/png"),colorSpaceOutput.appendChild(n)}function makeColorSpace(e){let t=downscaleImage(e);generateColorSpace(0,2,t),generateColorSpace(1,0,t),generateColorSpace(2,1,t)}function upscaleImage(e){let t=document.createElement("canvas"),a=e.naturalWidth,l=e.naturalHeight;t.width=2*a,t.height=2*l;let o=t.getContext("2d");o.imageSmoothingEnabled=!1,o.webkitImageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,o.drawImage(e,0,0,2*a,2*l),upscaledImage.appendChild(t)}function displayImage(e){let t=document.createElement("img");t.src=URL.createObjectURL(e[0]),t.onload=function(){colorBuckets=[],sortImage(t),makeHistogram(t),makeColorSpace(t),makePalette(t,2),upscaleImage(t);let e=[...new Set(getAverages().map(e=>e.join(",")))].map(e=>e.split(",").map(e=>parseInt(e)));for(let t=0;t<e.length;t++){let a=document.createElement("div");a.classList.add("bucketHolder");let l=document.createElement("p");l.innerText="COPY",l.classList.add("copy");let o=rgbToHex(e[t][0],e[t][1],e[t][2]),r=document.createElement("div");r.classList.add("bucket"),r.style.backgroundColor=o,r.setAttribute("data-clipboard-action","copy"),r.setAttribute("data-clipboard-text",o),r.addEventListener("mouseenter",()=>{l.style.visibility="visible"}),r.addEventListener("mouseleave",()=>{l.style.visibility="hidden"}),l.style.color=e[t][0]+e[t][1]+e[t][2]>=382.5?"black":"white";let n=document.createElement("p");n.classList.add("colorName"),getColorName(o.substring(1)).then(e=>{n.innerText=e.name.value}),r.appendChild(l),a.appendChild(r),a.appendChild(n),paletteOutput.appendChild(a)}},imagePreview.appendChild(t)}document.ondrop=(e=>{results.style.display="flex",drop.style.margin=0,e.preventDefault(),reset(),displayImage(e.dataTransfer.files)}),document.ondragover=(e=>{e.preventDefault()}),document.ondragleave=(e=>{e.preventDefault()}),dropText.onclick=(()=>{dropInput.click()}),dropInput.onchange=function(){results.style.display="flex",drop.style.margin=0,reset(),displayImage(this.files)},window.addEventListener("resize",()=>{if(canvasHolder.childNodes[1]){e.remove();let e=new p5(histogram)}});